<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= title %></title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: #e8f4f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: fixed;
            width: 100%;
            touch-action: none;
        }

        .header {
            width: 100%;
            background: linear-gradient(135deg, #4a90e2, #67a6e5);
            color: white;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(74, 144, 226, 0.2);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 408px;
            padding: 15px;
            box-sizing: border-box;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            color: white;
            flex: 1;
            max-width: 150px;
            font-weight: 500;
        }

        .btn-new {
            background: linear-gradient(135deg, #34ace0, #63cdff);
        }

        .btn-exit {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }

        .stats {
            background-color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 15px rgba(74, 144, 226, 0.1);
            margin: 10px 0;
            display: flex;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8fa6;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #4a90e2;
        }

        #game {
            width: 408px;
            height: 408px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(74, 144, 226, 0.1);
            padding: 10px;
            box-sizing: border-box;
        }

        .game_item {
            height: 90px;
            width: 90px;
            margin: 2px;
            border-radius: 8px;
            background: linear-gradient(135deg, #67a6e5, #4a90e2);
            color: white;
            text-align: center;
            line-height: 90px;
            cursor: pointer;
            user-select: none;
            font-size: 24px;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .game_item:empty {
            background: #e8f4f8;
        }

        .game_item:hover:not(:empty) {
            transform: scale(1.02);
        }

        @media (max-width: 480px) {
            #game {
                width: 300px;
                height: 300px;
                margin: 10px auto;
            }

            .game_item {
                height: 65px;
                width: 65px;
                line-height: 65px;
                font-size: 18px;
                margin: 2px;
            }

            .controls {
                max-width: 300px;
                padding: 10px;
            }

            .header h1 {
                font-size: 24px;
                margin: 8px 0;
            }

            .stats {
                padding: 8px 15px;
                margin: 8px 0;
            }

            .stat-value {
                font-size: 18px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
        }

        .firework-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }

        .firework {
            position: absolute;
            bottom: 0;
            animation: launch 1s ease-out forwards;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
        }

        @keyframes launch {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-60vh);
            }
        }

        @keyframes explode {
            0% {
                transform: translate(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ•°å­—åå®¹é“</h1>
    </div>

    <div class="controls">
        <button class="btn btn-exit" onclick="exitGame()">é€€å‡º</button>
        <button class="btn btn-new" onclick="startNewGame()">æ–°æ¸¸æˆ</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <span class="stat-label">æ—¶é—´</span>
            <span class="stat-value" id="timer">00:00</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">æ­¥æ•°</span>
            <span class="stat-value" id="moves">0</span>
        </div>
    </div>

    <div id="game"></div>

    <script>
        //åˆå§‹å¸ƒå±€
        var numberList = [[1, 2, 3, 4],
                        [5, 6, 7, 8],
                        [9, 10, 11, 12],
                        [13, 14, 15, 0]];
        //0æ‰€å¤„çš„ä½ç½®
        var zeroRow = 3;
        var zeroCol = 3;
        let moves = 0;
        let timer;
        let seconds = 0;
        let isShuffling = false;

        function updateTimer() {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            seconds++;
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            seconds = 0;
            timer = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function updateMoves() {
            moves++;
            document.getElementById('moves').textContent = moves;
        }

        function startNewGame() {
            moves = 0;
            document.getElementById('moves').textContent = '0';
            // é‡ç½®åˆå§‹å¸ƒå±€
            numberList = [[1, 2, 3, 4],
                        [5, 6, 7, 8],
                        [9, 10, 11, 12],
                        [13, 14, 15, 0]];
            zeroRow = 3;
            zeroCol = 3;
            chaos();
            // åœ¨æ‰“ä¹±ä¹‹åå¯åŠ¨è®¡æ—¶å™¨
            startTimer();
        }

        function exitGame() {
            if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                window.location.href = '/';
            }
        }

        //æ‰“ä¹±çš„å‡½æ•°
        function chaos() {
            isShuffling = true;  // å¼€å§‹æ‰“ä¹±
            //éšæœºå¾ªç¯æ¬¡æ•°å–[50, 100)
            var rCount = Math.floor(Math.random() * 50 + 50);
            for(let i = 0; i <= rCount; i++) {
                //éšæœºå‡º0å°†è¦å»çš„ä½ç½®
                let rRow = Math.floor(Math.random() * 4);
                let rCol = Math.floor(Math.random() * 4);
                zeroRun(rRow, rCol);
            }
            
            // å¦‚æœæ‰“ä¹±åæ°å¥½æ˜¯èƒœåˆ©çŠ¶æ€ï¼Œåˆ™å†æ¬¡æ‰“ä¹±
            if (win()) {
                chaos();
                return;
            }
            isShuffling = false;  // æ‰“ä¹±ç»“æŸ
        }

        function zeroRun(row, col) {
            // å¦‚æœåœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—ï¼Œç›´æ¥è¿”å›
            if (row !== zeroRow && col !== zeroCol) {
                return;
            }
            
            //ç§»åŠ¨ä½ç½®ä¸å˜çš„è¯ï¼Œç›´æ¥return
            if (numberList[row][col] === 0) {
                return;
            }

            // è®°å½•ç§»åŠ¨å‰çš„ä½ç½®
            const oldZeroRow = zeroRow;
            const oldZeroCol = zeroCol;

            //0ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼ˆæ¨ªåæ ‡ï¼‰
            if (row === zeroRow) {
                // æ°´å¹³ç§»åŠ¨
                const direction = col > zeroCol ? 1 : -1;
                for (let i = zeroCol; i !== col; i += direction) {
                    numberList[row][i] = numberList[row][i + direction];
                }
                numberList[row][col] = 0;
                zeroCol = col;
            } else {
                // å‚ç›´ç§»åŠ¨
                const direction = row > zeroRow ? 1 : -1;
                for (let i = zeroRow; i !== row; i += direction) {
                    numberList[i][col] = numberList[i + direction][col];
                }
                numberList[row][col] = 0;
                zeroRow = row;
            }

            // å¦‚æœç¡®å®å‘ç”Ÿäº†ç§»åŠ¨ï¼Œæ›´æ–°æ­¥æ•°
            if (oldZeroRow !== zeroRow || oldZeroCol !== zeroCol) {
                updateMoves();
            }

            renderGame();

            //åˆ¤æ–­æ˜¯å¦èƒœåˆ©ï¼ˆåªåœ¨éæ‰“ä¹±çŠ¶æ€ä¸‹åˆ¤æ–­ï¼‰
            if (!isShuffling && win()) {
                stopTimer();
                setTimeout(() => {
                    createFireworks();
                }, 100);
            }
        }

        function renderGame() {
            const gameDiv = document.getElementById("game");
            gameDiv.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    const gameItem = document.createElement("div");
                    gameItem.className = "game_item";
                    //å¦‚æœä¸º0çš„è¯ï¼Œä¸æ˜¾ç¤ºæ•°å­—
                    numberList[i][j] === 0 ? gameItem.innerText = "" : gameItem.innerText = numberList[i][j];
                    gameItem.setAttribute("row", i);
                    gameItem.setAttribute("col", j);
                    gameDiv.appendChild(gameItem);
                }
            }
        }

        //åˆ¤æ–­èƒœåˆ©
        function win() {
            // æ­£ç¡®çš„æ•°å­—åºåˆ—åº”è¯¥æ˜¯ 1-15 æŒ‰é¡ºåºæ’åˆ—ï¼Œæœ€åæ˜¯0
            const correctSequence = [
                [1, 2, 3, 4],
                [5, 6, 7, 8],
                [9, 10, 11, 12],
                [13, 14, 15, 0]
            ];
            
            // æ£€æŸ¥æ¯ä¸ªä½ç½®çš„æ•°å­—æ˜¯å¦æ­£ç¡®
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (numberList[i][j] !== correctSequence[i][j]) {
                        return false;
                    }
                }
            }
            return true;
        }

        // ç›‘å¬ç”¨æˆ·ç‚¹å‡»äº‹ä»¶
        document.getElementById("game").addEventListener("click", function(e) {
            // è·å–è¢«ç‚¹å‡»çš„å…ƒç´ 
            let clickedItem = e.target;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ•°å­—å—å†…çš„æ–‡æœ¬ï¼Œåˆ™è·å–çˆ¶å…ƒç´ 
            if (!clickedItem.hasAttribute("row")) {
                clickedItem = clickedItem.closest(".game_item");
            }
            
            if (clickedItem && clickedItem.className === "game_item") {
                let row = parseInt(clickedItem.getAttribute("row"));
                let col = parseInt(clickedItem.getAttribute("col"));
                
                // æ£€æŸ¥ç‚¹å‡»çš„ä½ç½®æ˜¯å¦åœ¨ç©ºæ ¼çš„åŒä¸€è¡Œæˆ–åŒä¸€åˆ—
                if (row === zeroRow || col === zeroCol) {
                    zeroRun(row, col);
                }
            }
        });

        // ç›‘å¬ç”¨æˆ·é”®ç›˜äº‹ä»¶
        document.onkeydown = function(e) {
            switch(e.code) {
                case "ArrowUp":
                    if (zeroRow === 3) return;
                    zeroRun(zeroRow + 1, zeroCol);
                    break;
                case "ArrowDown":
                    if (zeroRow === 0) return;
                    zeroRun(zeroRow - 1, zeroCol);
                    break;
                case "ArrowLeft":
                    if (zeroCol === 3) return;
                    zeroRun(zeroRow, zeroCol + 1);
                    break;
                case "ArrowRight":
                    if (zeroCol === 0) return;
                    zeroRun(zeroRow, zeroCol - 1);
                    break;
                default: 
                    break;
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        startNewGame();

        function createFireworks() {
            const container = document.createElement('div');
            container.className = 'firework-container';
            document.body.appendChild(container);

            // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createSingleFirework(container);
                }, i * 300); // æ¯éš”300mså‘å°„ä¸€ä¸ªçƒŸèŠ±
            }

            // æ˜¾ç¤ºè·èƒœä¿¡æ¯
            const message = document.createElement('div');
            message.style.position = 'fixed';
            message.style.top = '50%';
            message.style.left = '50%';
            message.style.transform = 'translate(-50%, -50%)';
            message.style.background = 'rgba(255, 255, 255, 0.95)';
            message.style.padding = '20px';
            message.style.borderRadius = '10px';
            message.style.boxShadow = '0 0 20px rgba(0,0,0,0.2)';
            message.style.zIndex = '1000';
            message.style.textAlign = 'center';
            message.innerHTML = `
                <h2 style="color: #4a90e2; margin: 0 0 10px 0; font-size: 24px;">ğŸ‰ æ­å–œä½ èµ¢äº†ï¼ğŸ‰</h2>
                <p style="margin: 5px 0; font-size: 18px;">ç”¨æ—¶: ${document.getElementById('timer').textContent}</p>
                <p style="margin: 5px 0; font-size: 18px;">æ­¥æ•°: ${moves}</p>
            `;
            document.body.appendChild(message);

            // 6ç§’åç§»é™¤çƒŸèŠ±å’Œæ¶ˆæ¯
            setTimeout(() => {
                container.remove();
                message.remove();
            }, 6000);
        }

        function createSingleFirework(container) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = Math.random() * 100 + 'vw';
            container.appendChild(firework);

            // çƒŸèŠ±é¢œè‰²
            const colors = [
                '#ff0000', '#00ff00', '#0000ff', '#ffff00', 
                '#ff00ff', '#00ffff', '#ff9900', '#ff0099'
            ];
            const color = colors[Math.floor(Math.random() * colors.length)];

            // çƒŸèŠ±çˆ†ç‚¸
            setTimeout(() => {
                firework.remove();
                createParticles(container, firework.offsetLeft, firework.offsetTop, color);
            }, 1000);
        }

        function createParticles(container, x, y, color) {
            // åˆ›å»ºå¤šä¸ªç²’å­
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.backgroundColor = color;

                // éšæœºæ–¹å‘å’Œè·ç¦»
                const angle = (Math.random() * Math.PI * 2);
                const velocity = Math.random() * 200 + 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                container.appendChild(particle);

                // 1ç§’åç§»é™¤ç²’å­
                setTimeout(() => particle.remove(), 1000);
            }
        }
    </script>
</body>
</html> 